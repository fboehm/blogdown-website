---
title: Translating GEMMAâ€™s Newton-Raphson Algorithm from C++ to R
author: Frederick Boehm
date: '2017-06-13'
slug: translating-gemma-s-newton-raphson-algorithm-from-c-to-r
draft: 'true'
categories:
  - Computing
tags:
  - Newton-Raphson
  - Linear mixed effects models
  - Variance components
  - R
---

## Overview

We want to translate GEMMA's C++ code in the function `MphNR` (in the file `mvlmm.cpp`) into R code as a way to better understand the calculations and the algorithm.

### `MphNR` C++ Code

`MphNR` is defined in [these lines](https://github.com/xiangzhou/GEMMA/blob/3ed15d7061fdac57c07da0fba087e9e69ac0ec42/src/mvlmm.cpp#L2504-L2662) in the GEMMA Github repository. 

### R code for `MphNR`

```{r}
MphNR <- function(){
  n_size <- length(eval)
  c_size <- nrow(X)
  d_size <- nrow(Y)
  dc_size <- d_size * c_size
  v_size <- d_size * (d_size + 1) / 2
  XXt <- X %*% t(X)
  log(det(XXt)) -> lndetXXt
  if (func_name == "R"){
    logl_const <- - 0.5 * (n_size - c_size) * d_size * log(2 * pi) + 0.5 * d_size * lndetXXt
  }
  for (t in 1:max_iter){
    Vg_save <- V_g
    Ve_save <- V_e
    step_scale <- 1
    step_iter <- 0
    while((flag_pd == 0 | logl_new<logl_old | logl_new - logl_old > 10 ) & step_iter < 10){
      V_g <- Vg_save
      V_e <- Ve_save
      if (t > 1){UpdateVeVg()}
      flag_pd <- matrixcalc::is.positive.definite(V_g) & matrixcalc::is.positive.definite(V_e)
			if (flag_pd == 1) {
			  if (func_name=='R') {
					logl_new <- logl_const - 0.5 * logdet_H - 0.5 * logdet_Q - 0.5 * yPy
			  }
			}
      step_scale <- step_scale / 2
      step_iter <- step_iter + 1
    } # end of while loop
    
  } # end of loop over t
} # end of function
```

The [do-while loop](https://github.com/xiangzhou/GEMMA/blob/3ed15d7061fdac57c07da0fba087e9e69ac0ec42/src/mvlmm.cpp#L2553-L2598) is a construction that I haven't seen before in C++. We can translate it into R by using a `while` loop.

`flag_pd` is an indicator for positive-definite matrices.

### `CalcHiQi`


### `Calc_Hiy_all`


### `Calc_xHi_all`


### `Calc_xHiy`


### `Calc_yHiy`











